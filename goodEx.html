<html>
	<head>
		<meta charset="utf-8">
		<title>Управление Торговыми представителями</title>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		<style>
			/* Style the form */
			#regForm {
			  background-color: #fff;
			  margin: 100px auto;
			  padding: 40px;
			  width: 70%;
			  min-width: 300px;
			  color: black;
			  border-top: 10px solid red;
			  min-width:800px;
			}
			body
			{
				background-color: lightgray;
				background-size: contain;
				background-position: bottom center;
				background-repeat: no-repeat;
				font-family: Arial;
				color: black;
			}
			/* Style the input fields */
			input {
			  padding: 10px;
			  width: 100%;
			  font-size: 17px;
			  font-family: Raleway;
			  border: 1px solid #aaaaaa;
			  border-radius: 10px;
			}
			
			input[type='radio'] {
				margin:5px;
			}
			
			.tab {border-bottom: 1px solid black; padding-bottom: 10px;}
			.tab:last-of-type td:not(:first-of-type) {min-width: 100px; width: 20%; text-align:center;}
			.tab:last-of-type tr:nth-of-type(2) td {text-align: center;}
			.tab:last-of-type td:first-of-type {min-width: 100px; width: 10%;}
			.tab:last-of-type tr td:nth-of-type(3) input {margin-left: 10px;}
			.tab:nth-of-type(3) td:first-of-type {min-width: 200px; text-align: left;}
			.tab:nth-of-type(3) td {text-align: center;}
			
			button {
				margin-top: 20px;
				width: 100%;
				height: 40px;
				border: none;
				border-radius: 15px;
			}
			
			button[onclick='newDot()'] {background:red; font-size: 1.3em; color: white;}
			#mainbutton {position: fixed; top:0; margin: 1%; width: 13%; vertical-align: center; height: 10%;}
			#total {text-align: center; font-weight: bold;}
			#tables tr:first-of-type {font-weight: bold; }
			#tables td {padding: 10px; font-size: 1.2em; width: 25%; text-align: center;}
			#tables input {height: 35px;}
			label, textarea {width:100%;}
			#textarea {border-top: 1px solid gray; padding-top: 10px; padding-bottom: 20px;}
			#saleRepresantatives {width: 100%; border-bottom: 1px solid black; margin-bottom: 20px;}
			#saleRepresantatives td {width: 20%;}
			#saleRepresantatives select {width:100%; font-size: 1.3em; margin-bottom: 5px;} 
			
			.sub td {border: none;}
			.sub tr:first-of-type td {border-bottom: 1px solid gray;}
			.sub td:last-of-type {border-left:1px solid red;}
			.sub tr:nth-of-type(11) td,.sub tr:nth-of-type(12) td,.sub tr:nth-of-type(13) td {border:none}
			.sub tr:nth-of-type(11) {border-bottom: 1px solid gray;}
			
			table {
				width:100%;
			}
			table td {padding: 5px; font-weight: bold; border: 1px solid gray; text-align:center;}
			table td:first-of-type {width:20%;}
			
			@media (orientation: portrait) {
				#regForm {width: 80%; font-size: 15pt;}
				#saleRepresantatives {font-size: 15pt;}
				#regForm input {height: 5%; font-size: 15pt;}
				#regForm button {height: 5%; width: 100%; font-size: 30pt;}
				#chooseDot {font-size: 24pt;}
				#mainbutton {font-size: 2em; padding: 0%; height: 6%!important;;} 
			}
		</style>
	</head>
	<body>
	
		<a href='saleMan.html'>
			<button type="button" id='mainbutton' class="btn btn-danger btn-lg btn-block">
				Назад
			</button>
		</a>
		
		<div id="regForm" >

			<table id="saleRepresantatives" class="tab">
				<tr>
					<td>
						<h4>Торговый Представитель:</h4>
					</td>
					<td colspan='4'>
						<select onchange='getContact(this.value);'>
						</select>
					</td>
				</tr>
			</table>

			<form class="tab"><h3>Информация о Торговом Представителе:</h3>
			  <p><input placeholder="Имя..." oninput="this.className = ''"></p>
			  <p><input placeholder="Фамилия..." oninput="this.className = ''"></p>
			  <p><input placeholder="Телефон..." oninput="this.className = ''"></p>
			  <p><input placeholder="E-mail..." oninput="this.className = ''"></p>
			  
				<table>
					<tr>
						<td>
							Товар
						</td>
						<td>
							Личный склад
						</td>
					</tr>
					<tr>
						<td>CORVUS STRONG</td>
						<td class='pW'></td>
					</tr>
					<tr>
						<td>CORVUS EXTREME</td>
						<td class='pW'></td>
					</tr>
					<tr>
						<td>CORVUS BRUTAl</td>
						<td class='pW'></td>
					</tr>
					<tr>
						<td>CORVUS HULK</td>
						<td class='pW'></td>
					</tr>
					<tr>
						<td>CORVUS FLASH</td>
						<td class='pW'></td>
					</tr>
					<tr>
						<td>CORVUS JOKER</td>
						<td class='pW'></td>
					</tr>
					<tr>
						<td>CORVUS LOGAN</td>
						<td class='pW'></td>
					</tr>
					<tr>
						<td>CNH ORIGINAL</td>
						<td class='pW'></td>
					</tr>
					<tr>
						<td>CNH STRONG</td>
						<td class='pW'></td>
					</tr>
				</table>
			  
			  <button type='button' onclick='updateContact()'>Изменить</button>
			</form>

			<form class="tab sub"><h2>Выдача товара:</h2>
			  <table>
				<tr>
					<td><h4>Продукт</h4></td>
					<td><h4>Цена</h4></td>
					<td><h4>Цена прошлая</h4></td>
					<td><h4>Количество</h4></td>
					<td><h4>Количество прошлое</h4></td>
					<td><h4>Итого</h4></td>
				</tr>
				<tr>
					<td><h3>CORVUS STRONG</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=180 data-count='1'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='1'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CORVUS EXTREME</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=180 data-count='2'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='2'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CORVUS BRUTAl</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=180 data-count='3'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='3'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CORVUS HULK</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=200 data-count='4'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='4'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CORVUS FLASH</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=200 data-count='5'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='5'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CORVUS JOKER</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=200 data-count='6'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='6'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CORVUS LOGAN</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=200 data-count='7'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='7'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CNH ORIGINAL</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=220 data-count='8'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='8'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>

				</tr>
				<tr>
					<td><h3>CNH STRONG</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=220 data-count='9'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='9'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td>
						<h3>
							Сумма: 
						</h3>
					</td>
					<td colspan='4' id='total'></td>
					<td></td>
				</tr>
				<tr>
					<td>
						<h3>
							Долг: 
						</h3>
					</td>
					<td colspan='4'></td>
					<td></td>
				</tr>
				
			  </table>
			  <button type='button' onclick='addDeal()'>Отправить</button>
			</form>

		</div>
		<script src='js/cookie.js'></script>
		<script>
			var today = new Date();
			var year = today.getFullYear();
			var month = today.getMonth();
			var date = today.getDate();
			var List = [];
			var x = document.getElementsByClassName("tab");
			var d = new Date();
			var currentID = userID;
			var saleRep = document.getElementById('saleRepresantatives');
			var saleChoice = saleRep.getElementsByTagName('select');
			var url = 'https://ac-amo.ru/corvusform/goodEx.html';
			var priceList = [180,180,180,200,200,200,200,220,220]; 
			var quantityList = [0,0,0,0,0,0,0,0,0]; 
			var p = x[2].getElementsByClassName('pastPrice');
			var q = x[2].getElementsByClassName('pastQuantity');
			z = x[1].getElementsByTagName("input");
			y = x[1].getElementsByClassName('pW');
			f = x[2].getElementsByTagName('td');
			var IDcontact;
			var start; 
			var end; 
			var dealName;
			var ident;
			var paddatepart = function(part) {
				 return part >= 10 ? part.toString() : '0' + part.toString();
			};

			var date2str = function(d) {
				 return d.getFullYear() + '-' + paddatepart(1 + d.getMonth()) + '-' + paddatepart(d.getDate()) + 'T' + paddatepart(d.getHours()) + ':' + paddatepart(d.getMinutes()) + ':' + paddatepart(d.getSeconds()) + '+03:00';
			};

			function accessInfo() {
				switch(access) {
					case '0':
						mng = '76';
						saleRep.style.display = 'none';
						dealList(userID);
						break;
					case '1':
						mng = '77';
						getDepartment(depID);
						break; 
				}
			}
			
			function chooseContact(id,deal=0) {
				start = new Date();
				start = date2str(start);
				id = parseInt(id,10);
				ident = id; 
				console.log(List);
				dotContact = List[id].ID;
				console.log(z[0].value);
				z[0].value = List[id].NAME;
				z[1].value = List[id].LAST_NAME;
				z[2].value = List[id].UF_CRM_1573312161072;
				z[3].value = List[id].UF_CRM_1573312294114;
				
				p[0].innerHTML = List[id].UF_CRM_1573310351288;
				p[1].innerHTML = List[id].UF_CRM_1573310278033;
				p[2].innerHTML = List[id].UF_CRM_1573310225736;
				p[3].innerHTML = List[id].UF_CRM_1573310510848;
				p[4].innerHTML = List[id].UF_CRM_1573310451064;
				p[5].innerHTML = List[id].UF_CRM_1573310557792;
				p[6].innerHTML = List[id].UF_CRM_1573310598225;
				p[7].innerHTML = List[id].UF_CRM_1573310123849;
				p[8].innerHTML = List[id].UF_CRM_1573310175080;
				q[0].innerHTML = List[id].UF_CRM_1573310369312;
				q[1].innerHTML = List[id].UF_CRM_1573310256279;
				q[2].innerHTML = List[id].UF_CRM_1573310200368;
				q[3].innerHTML = List[id].UF_CRM_1573310490520;
				q[4].innerHTML = List[id].UF_CRM_1573310425433;
				q[5].innerHTML = List[id].UF_CRM_1573310531872;
				q[6].innerHTML = List[id].UF_CRM_1573310576552;
				q[7].innerHTML = List[id].UF_CRM_1573309994918;
				q[8].innerHTML = List[id].UF_CRM_1573310153776;
				
				y[0].innerHTML = List[id].UF_CRM_1573311099815;
				y[1].innerHTML = List[id].UF_CRM_1573311046657;
				y[2].innerHTML = List[id].UF_CRM_1573311030935;
				y[3].innerHTML = List[id].UF_CRM_1573311062519;
				y[4].innerHTML = List[id].UF_CRM_1573311052711;
				y[5].innerHTML = List[id].UF_CRM_1573311074464;
				y[6].innerHTML = List[id].UF_CRM_1573311086798;
				y[7].innerHTML = List[id].UF_CRM_1573310996682;
				y[8].innerHTML = List[id].UF_CRM_1573311018736;
				
				f[64].innerHTML = List[id].UF_CRM_1573311512826;
				debt = parseInt(List[id].UF_CRM_1573311512826);
				
				dealName = 'Выдача товара '+List[id].LAST_NAME+' '+List[id].NAME;
				IDcontact = parseInt(List[id].ID); 
			}
			
			function updateContact() {
				fetch('https://crm.corvus.ru/rest/47/7i7psg9pzq0nvc4p/crm.contact.update/', {
					method: 'POST',
					headers: {
					'Content-Type': 'application/json;charset=utf-8'
					},
					body: JSON.stringify({
						'ID':IDcontact,
						'FIELDS':{
							'NAME':y[0].value,
							'LAST_NAME':y[1].value,
							'UF_CRM_1573312161072':y[2].value,
							'UF_CRM_1573312294114':y[3].value
						}
					})
				}).then((response) => {
					console.log(response);
					response.json().then((data) => {
						alert("Данные Торгового Представителя обновлены!");
					});
				});
			}
			
			function pastCont(y) {
				fetch('https://crm.corvus.ru/rest/47/7i7psg9pzq0nvc4p/crm.contact.update/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json;charset=utf-8'
					},
					body: JSON.stringify({
						'ID':IDcontact,
						'FIELDS':{
							'UF_CRM_1573310351288':checkGoods(0,y),
							'UF_CRM_1573310278033':checkGoods(2,y),
							'UF_CRM_1573310225736':checkGoods(4,y),
							'UF_CRM_1573310510848':checkGoods(6,y),
							'UF_CRM_1573310451064':checkGoods(8,y),
							'UF_CRM_1573310557792':checkGoods(10,y),
							'UF_CRM_1573310598225':checkGoods(12,y),
							'UF_CRM_1573310123849':checkGoods(14,y),
							'UF_CRM_1573310175080':checkGoods(16,y),
							'UF_CRM_1573310369312':parseInt(y[1].value),
							'UF_CRM_1573310256279':parseInt(y[3].value),
							'UF_CRM_1573310200368':parseInt(y[5].value),
							'UF_CRM_1573310490520':parseInt(y[7].value),
							'UF_CRM_1573310425433':parseInt(y[9].value),
							'UF_CRM_1573310531872':parseInt(y[11].value),
							'UF_CRM_1573310576552':parseInt(y[13].value),
							'UF_CRM_1573309994918':parseInt(y[15].value),
							'UF_CRM_1573310153776':parseInt(y[17].value),
							'UF_CRM_1573311099815':(parseInt(List[ident].UF_CRM_1573311099815)+parseInt(y[1].value)),
							'UF_CRM_1573311046657':(parseInt(List[ident].UF_CRM_1573311046657)+parseInt(y[3].value)),
							'UF_CRM_1573311030935':(parseInt(List[ident].UF_CRM_1573311030935)+parseInt(y[5].value)),
							'UF_CRM_1573311062519':(parseInt(List[ident].UF_CRM_1573311062519)+parseInt(y[7].value)),
							'UF_CRM_1573311052711':(parseInt(List[ident].UF_CRM_1573311052711)+parseInt(y[9].value)),
							'UF_CRM_1573311074464':(parseInt(List[ident].UF_CRM_1573311074464)+parseInt(y[11].value)),
							'UF_CRM_1573311086798':(parseInt(List[ident].UF_CRM_1573311086798)+parseInt(y[13].value)),
							'UF_CRM_1573310996682':(parseInt(List[ident].UF_CRM_1573310996682)+parseInt(y[15].value)),
							'UF_CRM_1573311018736':(parseInt(List[ident].UF_CRM_1573311018736)+parseInt(y[17].value)),
							'UF_CRM_1573311512826':(parseInt(f[61].innerHTML)+debt)
						}
					})
				}).then((response) => {
					console.log(response);
					response.json().then((data) => {
						console.log(parseInt(List[ident].UF_CRM_1573311074464,10)+parseInt(y[11].value,10));
						window.location.reload();
					});
				});
			}
			
			function addDeal() {
				if (confirm('Вы уверены, что хотите выдать товар?')) {
					end = new Date(); 
					end = date2str(end);
					fetch('https://crm.corvus.ru/rest/47/7i7psg9pzq0nvc4p/crm.deal.add/', {
						method: 'POST',
						headers: {
						'Content-Type': 'application/json;charset=utf-8'
						},
						body: JSON.stringify({
						'FIELDS':{
							'UF_CRM_1571203066750':start,
							'UF_CRM_1571203087218':end,
							'CATEGORY_ID':2,
							'TITLE':dealName,
							'UF_CRM_1573308832404':106,
							'CONTACT_ID':IDcontact,
							'STAGE_ID':"C2:WON",
							'ASSIGNED_BY_ID':userID
						},
						'PARAMS':{
							"REGISTER_SONET_EVENT": "Y"
						}
						})}).then((response) => {
						console.log(response);
						response.json().then((data) => {
							console.log(data.result);
							addGoods(data.result);
						});
					});
				}
			}
			
			function addGoods(dealID) {
				y = x[2].getElementsByTagName("input");
				console.log(y);
				fetch('https://crm.corvus.ru/rest/47/7i7psg9pzq0nvc4p/crm.deal.productrows.set/', {
					method: 'POST',
					headers: {
					'Content-Type': 'application/json;charset=utf-8'
					},
					body: JSON.stringify({
					'ID': dealID, 
					'ROWS':[
					{'PRODUCT_ID':200,'PRICE':checkGoods(0,y), 'QUANTITY':parseInt(y[1].value,10)},
					{'PRODUCT_ID':201,'PRICE':checkGoods(2,y), 'QUANTITY':parseInt(y[3].value,10)},
					{'PRODUCT_ID':202,'PRICE':checkGoods(4,y), 'QUANTITY':parseInt(y[5].value,10)},
					{'PRODUCT_ID':203,'PRICE':checkGoods(6,y), 'QUANTITY':parseInt(y[7].value,10)},
					{'PRODUCT_ID':204,'PRICE':checkGoods(8,y), 'QUANTITY':parseInt(y[9].value,10)},
					{'PRODUCT_ID':205,'PRICE':checkGoods(10,y), 'QUANTITY':parseInt(y[11].value,10)},
					{'PRODUCT_ID':291,'PRICE':checkGoods(12,y), 'QUANTITY':parseInt(y[13].value,10)},
					{'PRODUCT_ID':206,'PRICE':checkGoods(14,y), 'QUANTITY':parseInt(y[15].value,10)},
					{'PRODUCT_ID':207,'PRICE':checkGoods(16,y), 'QUANTITY':parseInt(y[17].value,10)}
					]})
				}).then((response) => {
					console.log(response);
					response.json().then((data) => {
						console.log(data.result);
						pastCont(y);
					});
				});
			}
						
			function getDepartment(id) {
				var zet = '';
				fetch('https://crm.corvus.ru/rest/47/wkn05dy055849bbq/crm.contact.list/', {
					method: 'POST',
					headers: {
					'Content-Type': 'application/json;charset=utf-8'
					},
					body: JSON.stringify({
						filter: {
						"UF_CRM_1573376299":id
						},
						select: [
							'NAME',
							'LAST_NAME',
							'UF_CRM_1573312161072',
							'UF_CRM_1573312294114',
							'UF_CRM_1573310351288',
							'UF_CRM_1573310278033',
							'UF_CRM_1573310225736',
							'UF_CRM_1573310510848',
							'UF_CRM_1573310451064',
							'UF_CRM_1573310557792',
							'UF_CRM_1573310598225',
							'UF_CRM_1573310123849',
							'UF_CRM_1573310175080',
							'UF_CRM_1573310369312',
							'UF_CRM_1573310256279',
							'UF_CRM_1573310200368',
							'UF_CRM_1573310490520',
							'UF_CRM_1573310425433',
							'UF_CRM_1573310531872',
							'UF_CRM_1573310576552',
							'UF_CRM_1573309994918',
							'UF_CRM_1573310153776',
							'UF_CRM_1573311099815',
							'UF_CRM_1573311046657',
							'UF_CRM_1573311030935',
							'UF_CRM_1573311062519',
							'UF_CRM_1573311052711',
							'UF_CRM_1573311074464',
							'UF_CRM_1573311086798',
							'UF_CRM_1573310996682',
							'UF_CRM_1573311018736',
							'UF_CRM_1573297783135',
							'UF_CRM_1573311512826'
						]
					})
				}).then((response) => {
					console.log(response);
					response.json().then((data) => {
						for (var i = 0; i < data.result.length; i++) {
							console.log(data.result[i].ID);
							zet += '<option value="'+i+'">'+data.result[i].NAME+'\u0020'+data.result[i].LAST_NAME+'</option>'
							List.push(data.result[i]);
						}
						saleChoice[0].innerHTML = zet;
						currentID = data.result[0].ID;
						chooseContact(0);
					});
				});
			}
			
			function calculate(className, count, num) {
				y = x[2].getElementsByTagName('tr');
				l = y[10].getElementsByTagName('td');
				z = y[num].getElementsByTagName('td');
				g = 0;
				switch(className) {
					case 'price':
						priceList[num-1] = count; 
						break;
					case 'quantity':
						quantityList[num-1] = count; 
						break;
				}
				z[5].innerHTML = (priceList[num-1]*quantityList[num-1]); 
				for (var i = 0; i < priceList.length; i++) {
					g += priceList[i]*quantityList[i]; 
				}
				l[1].innerHTML = g;
			}
			
			function checkGoods(num,y) {
				if (y[num+1].value != "") {
					console.log(y[num].value);
					return parseInt(y[num].value);
				} else {
					return ''; 
				}
			}
			
			getDepartment(userID);
		</script>
	</body>
</html>