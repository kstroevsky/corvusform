<html>
	<head>
		<meta charset="utf-8">
		<title>Форма для Торговых Представителей</title>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
		<style>
			/* Style the form */
			#regForm {
			  background-color: #fff;
			  margin: 100px auto;
			  padding: 40px;
			  width: 70%;
			  min-width: 300px;
			  color: black;
			  border-top: 10px solid red;
			  min-width:800px;
			}
			.pastQuantity,.pastPrice {width:50px; font-size: 1.2em;}
			h4 {font-size: 1.2em;}
			h3 {font-size:1.3em;}
			.sub td {width:130px; padding-left:10px; min-width:60px; vertical-align:center;}
			.sub tr:not(:first-of-type) td:nth-of-type(6) {border-left:1px solid red;}
			body
			{
				background-color: lightgray;
				background-size: contain;
				background-position: bottom center;
				background-repeat: no-repeat;
				font-family: Arial;
				color: black;
			}
			/* Style the input fields */
			input {
			  padding: 10px;
			  width: 100%;
			  font-size: 17px;
			  font-family: Raleway;
			  border: 1px solid #aaaaaa;
			  border-radius: 10px;
			}
			
			input[type='radio'] {
				margin:5px;
			}
			
			.tab {border-bottom: 1px solid black; padding-bottom: 10px;}
			.tab:last-of-type td:not(:first-of-type) {min-width: 100px; width: 20%; text-align:center;}
			.tab:last-of-type tr:nth-of-type(2) td {text-align: center;}
			.tab:last-of-type td:first-of-type {min-width: 100px; width: 10%;}
			.tab:last-of-type tr td:nth-of-type(3) input {margin-left: 10px;}
			.tab:nth-of-type(3) td:first-of-type {min-width: 200px; text-align: left;}
			.tab:nth-of-type(3) td {text-align: center;}
			.tab:nth-of-type(3) tr:nth-of-type(12) {border-top: 1px solid gray;}
			
			button {
				margin-top: 20px;
				width: 100%;
				height: 40px;
				border: none;
				border-radius: 15px;
			}
			
			#chooseDot {width: 100%;}
			#chooseDot tr:hover {background-color: lightgray;}
			#chooseDot tr:first-of-type {font-weight: bold;}
			#chooseDot tr:first-of-type:hover {
				background-color: white;
			}

			
			button[onclick='newDot()'] {background:red; font-size: 1.3em; color: white;}
			#mainbutton {position: fixed; top:0; margin: 1%; width: 13%; vertical-align: center; height: 10%;}
			#total {text-align: center; font-weight: bold;}
			#tables tr:first-of-type {font-weight: bold; }
			#tables td {padding: 10px; font-size: 1.2em; width: 25%; text-align: center;}
			#tables input {height: 35px;}
			#tables tr:nth-of-type(9) {border-top: 1px solid gray; font-weight: bold;}
			#tables tr:nth-of-type(10) {font-weight: bold; border-top: 1px solid red;}
			label, textarea {width:100%;}
			#textarea {border-top: 1px solid gray; padding-top: 10px; padding-bottom: 20px;}
			#saleRepresantatives {width: 100%; border-bottom: 1px solid black; margin-bottom: 20px;}
			#saleRepresantatives td {width: 20%;}
			#saleRepresantatives select {width:100%; font-size: 1.3em; margin-bottom: 5px;} 
			
			form select {font-size: 1.4em; width: 100%;}
			
			@media (orientation: portrait) {
				#regForm {width: 80%; font-size: 15pt;}
				#saleRepresantatives {font-size: 15pt;}
				#regForm input {height: 5%; font-size: 15pt;}
				#regForm button {height: 5%; width: 100%; font-size: 30pt;}
				#chooseDot {font-size: 15pt;}
				#mainbutton {font-size: 2em; padding: 0%; height: 6%!important;;} 
				form option {font-size: 0.4em; width: 100%;}
				#tables input {height: 35px;}
			}
		</style>
	</head>
	<body>
	
		<a href='saleMan.html'>
			<button type="button" id='mainbutton' class="btn btn-danger btn-lg btn-block">
				Назад
			</button>
		</a>
		
		<div id="regForm" >

			<table id="saleRepresantatives">
				<tr>
					<td>
						<h4>Торговый Представитель:</h4>
					</td>
					<td colspan='4'>
						<select onchange='dealList(this.value);'>
						</select>
					</td>
				</tr>
			</table>

			<form class="tab"><h3>Торговая точка:</h3>
			  <table id='chooseDot'>
			  </table>
			</form>

			<form class="tab"><h3>Информация о торговой точке:</h3>
			  <p><input placeholder="Название..." oninput="this.className = ''"></p>
			  <p><input placeholder="Регион..." oninput="this.className = ''"></p>
			  <p><input placeholder="Город..." oninput="this.className = ''"></p>
			  <p><input placeholder="Адрес 1..." oninput="this.className = ''"></p>
			  <p><input placeholder="Адрес 2..." oninput="this.className = ''"></p>
			  <p><input placeholder="ФИО 1..." oninput="this.className = ''"></p>
			  <p><input placeholder="Телефон 1..." oninput="this.className = ''"></p>
			  <p><input placeholder="ФИО 2..." oninput="this.className = ''"></p>
			  <p><input placeholder="Телефон 2..." oninput="this.className = ''"></p>
			  
			  <div id='textarea'>
				<label>
					<h4>Комментарий:</h4>
					<textarea></textarea>
				</label>
			  </div>
			  
			  <div id='tables'>
				  <table class='extInfo'>
						<tr>
							<td>
								Рекламные материалы
							</td>
							<td>
								До визита
							</td>
							<td>
								После визита
							</td>
						</tr>
						<tr>
							<td>
								Наклейка (у входа)
							</td>
							<td>
								<input type="checkbox" class='ads' value="46">
							</td>
							<td>
								<input type="checkbox" class='ads' value="56">
							</td>
						</tr>
						<tr>
							<td>
								Наклейка (у кассы)
							</td>
							<td>
								<input type="checkbox" class='ads' value="47">
							</td>
							<td>
								<input type="checkbox" class='ads' value="57">
							</td>
						</tr>
						<tr>
							<td>
								Стенд
							</td>
							<td>
								<input type="checkbox" class='ads' value="48">
							</td>
							<td>
								<input type="checkbox" class='ads' value="58">
							</td>
						</tr>
						<tr>
							<td>
								Плакат
							</td>
							<td>
								<input type="checkbox" class='ads' value="49">
							</td>
							<td>
								<input type="checkbox" class='ads' value="59">
							</td>
						</tr>
						<tr>
							<td>
								Баннер
							</td>
							<td>
								<input type="checkbox" class='ads' value="50">
							</td>
							<td>
								<input type="checkbox" class='ads' value="60">
							</td>
						</tr>
						<tr>
							<td>
								Воблер
							</td>
							<td>
								<input type="checkbox" class='ads' value="51">
							</td>
							<td>
								<input type="checkbox" class='ads' value="61">
							</td>
						</tr>
						<tr>
							<td>
								Пробники
							</td>
							<td>
								<input type="checkbox" class='ads' value="52">
							</td>
							<td>
								<input type="checkbox" class='ads' value="62">
							</td>
						</tr>
						<tr>
							<td>
								Товарная выкладка
							</td>
							<td colspan='2'>
								<input type="checkbox" class='ads' value="62">
							</td>
						</tr>
						<tr>
							<td>
								Товарная отгрузка
							</td>
							<td colspan='2'>
								<input type='checkbox' onchange='checkSale(this.checked)' checked>
							</td>
						</tr>
					</table>
				</div>
			</form>
			
			<form class="tab sub"><h2>Отгрузка:</h2>
			  <table>
				<tr>
					<td><h4>Продукт</h4></td>
					<td><h4>Цена</h4></td>
					<td><h4>Цена прошлая</h4></td>
					<td><h4>Количество</h4></td>
					<td><h4>Количество прошлое</h4></td>
					<td><h4>Итого</h4></td>
				</tr>
				<tr>
					<td><h3>CORVUS STRONG</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=180 data-count='1'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='1'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CORVUS EXTREME</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=180 data-count='2'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='2'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CORVUS BRUTAl</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=180 data-count='3'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='3'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CORVUS HULK</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=200 data-count='4'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='4'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CORVUS FLASH</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=200 data-count='5'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='5'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CORVUS JOKER</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=200 data-count='6'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='6'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CORVUS LOGAN</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=200 data-count='7'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='7'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td><h3>CNH ORIGINAL</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=220 data-count='8'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='8'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>

				</tr>
				<tr>
					<td><h3>CNH STRONG</h3></td>
					<td><p><input placeholder="Цена..." oninput="calculate(this.className, this.value, this.dataset.count)" class='price' value=220 data-count='9'></p></td>
					<td class='pastPrice'></td>
					<td><p><input placeholder="Количество..." oninput="calculate(this.className, this.value, this.dataset.count)" class='quantity' data-count='9'></p></td>
					<td class='pastQuantity'></td>
					<td class='total'></td>
				</tr>
				<tr>
					<td>
						<h3>
							Сумма: 
						</h3>
					</td>
					<td colspan='4' id='total'></td>
					<td></td>
				</tr>
				<tr>
					<td>
						<h3>
							Долг: 
						</h3>
					</td>
					<td colspan='4'></td>
					<td></td>
				</tr>
				<tr>
					<td>
						<h3>
							Оплата: 
						</h3>
					</td>
					<td colspan='4'>
						<input placeholder='Сколько денег вы получили: ' onchange='computeDebt(this.value)'>
					</td>
					<td></td>
				</tr>

			  </table>
			  
			</form>
			
			<form class="tab sub"><h2>Конкуренты:</h2>
			  <table>
				<tr>
					<td rowspan='2'>
						<h4>Продукт</h4>
					</td>
					<td rowspan='2'>
						<h4>Количество SKU</h4>
					</td>
					<td colspan='2'>
						<h4>Цена</h4>
					</td>
				</tr>
				<tr>
					<td>
						<h4>От</h4>
					</td>
					<td>
						<h4>До</h4>
					</td>
				</tr>
				<tr>
					<td><h3>LYFT</h3></td>
					<td><p><input placeholder="Количество..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="От..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="До..." oninput="this.className = ''"></p></td>
				</tr>
				<tr>
					<td><h3>FEDRS</h3></td>
					<td><p><input placeholder="Количество..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="От..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="До..." oninput="this.className = ''"></p></td>
				</tr>
				<tr>
					<td><h3>BLAX</h3></td>
					<td><p><input placeholder="Количество..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="От..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="До..." oninput="this.className = ''"></p></td>
				</tr>
				<tr>
					<td><h3>ARQA</h3></td>
					<td><p><input placeholder="Количество..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="От..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="До..." oninput="this.className = ''"></p></td>
				</tr>
				<tr>
					<td><h3>RED/ALFA</h3></td>
					<td><p><input placeholder="Количество..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="От..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="До..." oninput="this.className = ''"></p></td>
				</tr>
				<tr>
					<td><h3>NICTECH</h3></td>
					<td><p><input placeholder="Количество..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="От..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="До..." oninput="this.className = ''"></p></td>
				</tr>
				<tr>
					<td><h3>Oden’s (cold dry)</h3></td>
					<td><p><input placeholder="Количество..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="От..." oninput="this.className = ''"></p></td>
					<td><p><input placeholder="До..." oninput="this.className = ''"></p></td>
				</tr>
			  </table>
			  
			  <button type='button' onclick='updateCompetitors()'>Подтвердить</button>
			</form>

		</div>
		<script src='js/cookie.js'></script>
		<script>
			var today = new Date();
			var year = today.getFullYear();
			var month = today.getMonth();
			var date = today.getDate();
			var priceList = [180,180,180,200,200,200,200,220,220]; 
			var quantityList = [0,0,0,0,0,0,0,0,0]; 
			var mng = '';
			var pln = 0;
			var itm = '0';
			var sle = 'C1:WON';
			var start = '';
			var end = ''; 
			var url = 'https://ac-amo.ru/corvusform/vizit.html'
			var phoneCompany = {};
			var x = document.getElementsByClassName("tab");
			var d = new Date();
			var dealID; 
			var p = x[2].getElementsByClassName('pastPrice');
			var q = x[2].getElementsByClassName('pastQuantity');
			var f = x[2].getElementsByTagName('td');
			var c = f[67].getElementsByTagName("input");
			var ta = x[1].getElementsByTagName('textarea');
			var ads = x[1].getElementsByClassName('extInfo');
			var adsInput = ads[0].getElementsByTagName('input');
			var saleRep = document.getElementById('saleRepresantatives');
			var saleChoice = saleRep.getElementsByTagName('select');
			var currentID = userID;
			var paddatepart = function(part) {
				 return part >= 10 ? part.toString() : '0' + part.toString();
			};

			var date2str = function(d) {
				 return d.getFullYear() + '-' + paddatepart(1 + d.getMonth()) + '-' + paddatepart(d.getDate()) + 'T' + paddatepart(d.getHours()) + ':' + paddatepart(d.getMinutes()) + ':' + paddatepart(d.getSeconds()) + '+03:00';
			};

			function accessInfo() {
				switch(access) {
					case '0':
						mng = '76';
						saleRep.style.display = 'none';
						dealList(userID);
						break;
					case '1':
						mng = '77';
						getDepartment(depID);
						break; 
				}
			}
			
			function dealList(id) {
				var chooseDot = x[0].getElementsByTagName('table');
				var z = '<tr><td>Точка</td><td>Адрес</td><td>Город</td></tr>'; 
				fetch('https://crm.corvus.ru/rest/47/7i7psg9pzq0nvc4p/crm.deal.list/', {
					method: 'POST',
					headers: {
					'Content-Type': 'application/json;charset=utf-8'
					},
					body: JSON.stringify({
						order: { "STAGE_ID": "ASC" }, 
						filter: { "ASSIGNED_BY_ID": parseInt(id), 'STAGE_ID': 'C1:NEW', 'CATEGORY_ID':'1', 'BEGINDATE':date2str(today)}, 
						select: [
							"ID",
							'TITLE',
							"COMPANY_ID",
							"UF_CRM_1570787333370",
							"UF_CRM_1570787345460",
							"UF_CRM_1570787361674",
							"UF_CRM_1571143357822",
							"UF_CRM_1571143472291"
						]
					})
				}).then((response) => {
					console.log(response);
					response.json().then((data) => {
						console.log(data.result);
						for (var i = 0; i < data.result.length; i++ ) {
							z += '<tr onclick="chooseCompany('+data.result[i].COMPANY_ID+',this.id)" id="'+data.result[i].ID+'"><td>'+
							data.result[i].TITLE+'</td><td>'+data.result[i].UF_CRM_1570787345460+'</td><td>'+
							data.result[i].UF_CRM_1570787333370+'</td></tr>'
						}
						chooseDot[0].innerHTML = z;
					});
				});
			}
			
			function updateCompetitors() {
				end = new Date(); 
				end = date2str(end);
				var y = x[3].getElementsByTagName("input");
				var c = f[67].getElementsByTagName("input");
				var adsBefore = [];
				var adsAfter = [];
				
				for (var i = 0; i < 10; i+=2) {
					if (adsInput[i].checked) {
						switch(adsInput[i].value) {
							case "46":
								adsBefore.push(46);
								break;
							case "47":
								adsBefore.push(47);
								break;
							case "48":
								adsBefore.push(48);
								break;
							case "49":
								adsBefore.push(49);
								break;
							case "50":
								adsBefore.push(50);
								break;
							case "51":
								adsBefore.push(51);
								break;
							case "52":
								adsBefore.push(52);
								break;
						}
					}
				}
				for (var i = 1; i < 10; i+=2) {
					if (adsInput[i].checked) {
						switch(adsInput[i].value) {
							case "56":
								adsAfter.push(56);
								break;
							case "57":
								adsAfter.push(57);
								break;
							case "58":
								adsAfter.push(58);
								break;
							case "59":
								adsAfter.push(59);
								break;
							case "60":
								adsAfter.push(60);
								break;
							case "61":
								adsAfter.push(61);
								break;
							case "62":
								adsAfter.push(62);
								break;
						}
					}
				}
				if  (adsInput[14].checked) {
					itm = '1';
				} 
				console.log(adsAfter);
				fetch('https://crm.corvus.ru/rest/47/7i7psg9pzq0nvc4p/crm.deal.update/', {
					method: 'POST',
					headers: {
					'Content-Type': 'application/json;charset=utf-8'
					},
					body: JSON.stringify({
					'ID': dealID, 
					'FIELDS':{
						'UF_CRM_1570787405723':parseInt(y[0].value,10),
						'UF_CRM_1570787420746':parseInt(y[1].value,10),
						'UF_CRM_1571169173469':parseInt(y[2].value,10),
						'UF_CRM_1570787435391':parseInt(y[3].value,10), 
						'UF_CRM_1570787447197':parseInt(y[4].value,10),
						'UF_CRM_1571169183950':parseInt(y[5].value,10),
						'UF_CRM_1570787460572':parseInt(y[6].value,10),
						'UF_CRM_1570787594044':parseInt(y[7].value,10),
						'UF_CRM_1571169238291':parseInt(y[8].value,10),
						'UF_CRM_1570787608705':parseInt(y[9].value,10), 
						'UF_CRM_1570787615600':parseInt(y[10].value,10),
						'UF_CRM_1571169247623':parseInt(y[11].value,10),
						'UF_CRM_1570787629867':parseInt(y[12].value,10),
						'UF_CRM_1570787638387':parseInt(y[13].value,10),
						'UF_CRM_1571169283552':parseInt(y[14].value,10),
						'UF_CRM_1570787652487':parseInt(y[15].value,10), 
						'UF_CRM_1570787659875':parseInt(y[16].value,10),
						'UF_CRM_1571169297457':parseInt(y[17].value,10),
						'UF_CRM_1573221531645':parseInt(y[18].value,10), 
						'UF_CRM_1573221542354':parseInt(y[19].value,10),
						'UF_CRM_1573221555622':parseInt(y[20].value,10),
						'UF_CRM_1573300258288':parseInt(c[0].value,10),
						'UF_CRM_1571143357822':adsBefore,
						'UF_CRM_1571143472291':adsAfter,
						'UF_CRM_1571203066750':start,
						'UF_CRM_1571203087218':end,
						'UF_CRM_1571203482940':mng,
						'UF_CRM_1571418066651':pln,
						'UF_CRM_1571418112930':itm,
						'COMMENTS':ta[0].value,
						'STAGE_ID':sle
					},
					'PARAMS':{
						"REGISTER_SONET_EVENT": "Y"
					}
					})}).then((response) => {
					console.log(response);
					response.json().then((data) => {
						if (sle == 'C1:WON') {
							addGoods(dealID);
						} else if (sle == 'C1:1') {
							updateCompany();
							alert('Визит прошел без отгрузки!');
						}
					});
				});
			}

			
			function getDepartment(id) {
				var zet = '';
				fetch('https://crm.corvus.ru/rest/47/wkn05dy055849bbq/user.get/', {
					method: 'POST',
					headers: {
					'Content-Type': 'application/json;charset=utf-8'
					},
					body: JSON.stringify({
						"UF_DEPARTMENT":id
					})
				}).then((response) => {
					console.log(response);
					response.json().then((data) => {
						for (var i = 0; i < data.result.length; i++) {
							switch(data.result[i].ID) {
								case userID:
									break;
								default:
									zet += '<option value="'+data.result[i].ID+'">'+decodeURIComponent(JSON.parse('"'+data.result[i].NAME+'\u0020'+data.result[i].LAST_NAME+'"'))+'</option>'
									break;
							}
						}
						saleChoice[0].innerHTML = zet;
						currentID = data.result[0].ID;
						dealList(currentID);
					});
				});
			}
			
			accessInfo();
		</script>
		<script src='js/dealWork.js'></script>
	</body>
</html>